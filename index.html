<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Medicamentos</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="script.js"></script>
</head>
<body>
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; padding: 20px; border-radius: 5px;">
            <i class="fas fa-spinner fa-spin"></i> Carregando...
        </div>
    </div>

    <div id="loginContainer" style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #f0f0f0;">
        <div style="text-align: center; padding: 20px; background: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
            <h2>Login</h2>
            <input type="number" id="userId" placeholder="Digite seu ID" style="margin: 10px; padding: 5px; width: 200px;">
            <button onclick="login()" style="padding: 5px 10px; background: #1a4f72; color: white; border: none; border-radius: 3px; cursor: pointer;">Entrar</button>
        </div>
    </div>

    <div id="appContainer" style="display: none; height: 100vh; display: flex;">
        <div id="sidebar" class="sidebar">
            <ul class="menu">
                <li data-module="dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
                <li id="menuCadastrar" data-module="cadastrar" style="display: none;"><i class="fas fa-plus"></i> Cadastrar</li>
                <li data-module="retirar"><i class="fas fa-minus"></i> Retirar</li>
                <li data-module="pesquisar"><i class="fas fa-search"></i> Pesquisar</li>
                <li id="menuRelatorios" data-module="relatorios" style="display: none;"><i class="fas fa-chart-bar"></i> Relatórios</li>
                <li id="menuUsuarios" data-module="usuarios" style="display: none;"><i class="fas fa-users"></i> Usuários</li>
                <li id="menuConfiguracoes" data-module="configuracoes" style="display: none;"><i class="fas fa-cog"></i> Configurações</li>
                <li data-module="sair" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</li>
            </ul>
        </div>
        <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleMenu()"></div>

        <div class="main-content">
            <div class="header">
                <button id="backBtn" style="margin-right: 10px; padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 3px; cursor: pointer;">Voltar</button>
                <h2 id="moduleTitle">Dashboard</h2>
                <div class="user-info">
                    <div class="avatar"></div>
                    <span id="userName"></span> (ID: <span id="userIdDisplay"></span>)
                    <span id="userTypeBadge"></span>
                </div>
            </div>

            <div id="mainContent">
                <div id="dashboard" class="module active">
                    <h2>Métricas</h2>
                    <p>Total de Medicamentos: <span id="totalMedicamentos"></span></p>
                    <p>Valor Total em Estoque: <span id="totalValor"></span></p>
                    <p>Próximos a Vencer: <span id="proximosVencimentos"></span></p>
                    <p>Gasto no Mês: <span id="totalGastoMes"></span></p>
                    <p>Medicamento Mais Utilizado: <span id="medicamentoMaisUtilizado"></span></p>
                    <h2>Últimas Movimentações</h2>
                    <table id="movimentacoesTable">
                        <thead><tr><th>Data</th><th>Medicamento</th><th>Lote</th><th>Quantidade</th><th>Valor Total</th><th>Usuário</th><th>Tipo</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <h2>5 Medicamentos Mais Usados</h2>
                    <table id="top5Medicamentos">
                        <thead><tr><th>Medicamento</th><th>Quantidade Usada</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <p id="storageInfo"></p>
                </div>

                <div id="cadastrar" class="module">
                    <h2>Cadastrar Medicamento</h2>
                    <input type="text" id="codigoBarras" placeholder="Código de Barras" style="margin: 5px; padding: 5px; width: 200px;">
                    <button onclick="iniciarScanner('codigoBarras')" style="margin: 5px; padding: 5px 10px;">Escanear</button>
                    <input type="text" id="nomeMedicamento" placeholder="Nome" style="margin: 5px; padding: 5px; width: 200px;">
                    <input type="text" id="fabricante" placeholder="Fabricante" style="margin: 5px; padding: 5px; width: 200px;">
                    <input type="text" id="lote" placeholder="Lote" style="margin: 5px; padding: 5px; width: 200px;">
                    <input type="number" id="quantidade" placeholder="Quantidade" style="margin: 5px; padding: 5px; width: 200px;" oninput="calcularValorUnitario()">
                    <input type="number" id="valorTotal" placeholder="Valor Total" step="0.01" style="margin: 5px; padding: 5px; width: 200px;" oninput="calcularValorUnitario()">
                    <p id="valorUnitarioInfo" style="margin: 5px;">Valor unitário: R$ 0,00</p>
                    <input type="date" id="validade" style="margin: 5px; padding: 5px; width: 200px;">
                    <textarea id="observacoes" placeholder="Observações" style="margin: 5px; padding: 5px; width: 200px; height: 50px;"></textarea>
                    <button onclick="cadastrarMedicamento()" style="margin: 5px; padding: 5px 10px; background: #1a4f72; color: white; border: none; border-radius: 3px; cursor: pointer;">Cadastrar</button>
                </div>

                <div id="retirar" class="module">
                    <h2>Retirar Medicamento</h2>
                    <input type="text" id="retirarCodigo" placeholder="Código de Barras" style="margin: 5px; padding: 5px; width: 200px;">
                    <button onclick="iniciarScanner('retirarCodigo')" style="margin: 5px; padding: 5px 10px;">Escanear</button>
                    <input type="text" id="medicamentoRetirada" placeholder="Medicamento" readonly style="margin: 5px; padding: 5px; width: 200px;">
                    <input type="text" id="loteRetirada" placeholder="Lote" readonly style="margin: 5px; padding: 5px; width: 200px;">
                    <input type="number" id="valorUnitarioRetirada" placeholder="Valor Unitário" readonly style="margin: 5px; padding: 5px; width: 200px;">
                    <input type="number" id="quantidadeRetirada" placeholder="Quantidade" style="margin: 5px; padding: 5px; width: 200px;" oninput="calcularValorTotalRetirada()">
                    <p id="valorTotalRetiradaInfo" style="margin: 5px;">Valor total: R$ 0,00</p>
                    <select id="tipoMovimentacao" onchange="toggleMotivoField()" style="margin: 5px; padding: 5px; width: 200px;">
                        <option value="saida">Saída</option>
                        <option value="devolucao">Devolução</option>
                    </select>
                    <div id="motivoField" style="margin: 5px;">
                        <input type="text" id="motivoRetirada" placeholder="Motivo" style="padding: 5px; width: 200px;">
                    </div>
                    <button onclick="processarMovimentacao()" style="margin: 5px; padding: 5px 10px; background: #1a4f72; color: white; border: none; border-radius: 3px; cursor: pointer;">Confirmar</button>
                </div>

                <div id="pesquisar" class="module">
                    <h2>Pesquisar Medicamentos</h2>
                    <input type="text" id="pesquisaTermo" placeholder="Pesquisar..." style="margin: 5px; padding: 5px; width: 200px;">
                    <select id="filtroStatus" onchange="filtrarMedicamentos()" style="margin: 5px; padding: 5px; width: 200px;">
                        <option value="todos">Todos</option>
                        <option value="disponivel">Disponível</option>
                        <option value="vencendo">Vencendo</option>
                        <option value="vencido">Vencido</option>
                        <option value="estoque-baixo">Estoque Baixo</option>
                    </select>
                    <table id="tabelaPesquisa">
                        <thead><tr><th>Código</th><th>Nome</th><th>Fabricante</th><th>Lote</th><th>Quantidade</th><th>Valor Unitário</th><th>Validade</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="relatorios" class="module">
                    <h2>Relatórios</h2>
                    <select id="tipoRelatorio" onchange="mudarTipoRelatorio()" style="margin: 5px; padding: 5px; width: 200px;">
                        <option value="movimentacoes">Movimentações</option>
                        <option value="estoque">Estoque</option>
                        <option value="vencimentos">Vencimentos</option>
                        <option value="valor">Valor em Estoque</option>
                    </select>
                    <select id="periodoRelatorio" onchange="mudarTipoRelatorio()" style="margin: 5px; padding: 5px; width: 200px;">
                        <option value="7">Últimos 7 dias</option>
                        <option value="30">Últimos 30 dias</option>
                        <option value="90">Últimos 90 dias</option>
                        <option value="personalizado">Personalizado</option>
                    </select>
                    <div id="periodoPersonalizado" style="display: none; margin: 5px;">
                        <input type="date" id="dataInicio" style="padding: 5px; width: 200px;">
                        <input type="date" id="dataFim" style="padding: 5px; width: 200px;">
                    </div>
                    <button onclick="gerarRelatorio()" style="margin: 5px; padding: 5px 10px;">Gerar</button>
                    <button onclick="exportarRelatorio()" style="margin: 5px; padding: 5px 10px;">Exportar CSV</button>
                    <table id="tabelaRelatorio"></table>
                    <div id="conteudoResumo"></div>
                    <canvas id="relatorioChart" style="max-width: 600px; max-height: 400px; margin: 5px;"></canvas>
                </div>

                <div id="usuarios" class="module">
                    <h2>Gerenciar Usuários</h2>
                    <input type="number" id="novoUsuarioId" placeholder="ID" style="margin: 5px; padding: 5px; width: 200px;">
                    <input type="text" id="novoUsuarioNome" placeholder="Nome" style="margin: 5px; padding: 5px; width: 200px;">
                    <select id="novoUsuarioTipo" style="margin: 5px; padding: 5px; width: 200px;">
                        <option value="comum">Comum</option>
                        <option value="admin">Admin</option>
                    </select>
                    <button onclick="cadastrarUsuario()" style="margin: 5px; padding: 5px 10px;">Cadastrar</button>
                    <table id="tabelaUsuarios">
                        <thead><tr><th>ID</th><th>Nome</th><th>Tipo</th><th>Data de Criação</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="configuracoes" class="module">
                    <h2>Configurações</h2>
                    <input type="email" id="emailNotificacao" placeholder="Email de Notificação" style="margin: 5px; padding: 5px; width: 200px;">
                    <input type="number" id="diasAlertaVencimento" placeholder="Dias de Alerta de Vencimento" style="margin: 5px; padding: 5px; width: 200px;">
                    <input type="number" id="limiteEstoqueBaixo" placeholder="Limite de Estoque Baixo" style="margin: 5px; padding: 5px; width: 200px;">
                    <select id="backupAuto" style="margin: 5px; padding: 5px; width: 200px;">
                        <option value="semanal">Semanal</option>
                        <option value="mensal">Mensal</option>
                        <option value="desativado">Desativado</option>
                    </select>
                    <select id="temaInterface" style="margin: 5px; padding: 5px; width: 200px;">
                        <option value="claro">Claro</option>
                        <option value="escuro">Escuro</option>
                    </select>
                    <button onclick="salvarConfiguracoes()" style="margin: 5px; padding: 5px 10px;">Salvar</button>
                    <button onclick="fazerBackup()" style="margin: 5px; padding: 5px 10px;">Fazer Backup</button>
                    <button onclick="restaurarBackup()" style="margin: 5px; padding: 5px 10px;">Restaurar Backup</button>
                    <button onclick="limparDadosAntigos()" style="margin: 5px; padding: 5px 10px;">Limpar Dados Antigos</button>
                    <button onclick="recalcularEstoque()" style="margin: 5px; padding: 5px 10px;">Recalcular Estoque</button>
                </div>
            </div>
        </div>

        <div id="scannerContainer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; justify-content: center; align-items: center;">
            <div style="background: white; padding: 20px; border-radius: 5px; text-align: center;">
                <video id="scannerVideo" style="width: 300px; height: 300px;" autoplay></video>
                <p id="scannerInstructions">Aponte a câmera para o código de barras ou QR code.</p>
                <div id="scannerError" style="display: none; color: red;">Erro ao acessar a câmera. Verifique as permissões.</div>
                <p id="cameraHelp" style="display: none;">Ajuda: Certifique-se de que a câmera está conectada e liberada.</p>
                <p id="cameraHelpRetirar" style="display: none;">Ajuda: Certifique-se de que a câmera está conectada e liberada.</p>
                <button onclick="fecharScanner()" style="margin-top: 10px; padding: 5px 10px;">Fechar</button>
            </div>
        </div>

        <div id="exitModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; justify-content: center; align-items: center;">
            <div style="background: white; padding: 20px; border-radius: 5px; text-align: center;">
                <h3>Confirmar Saída</h3>
                <p>Tem certeza que deseja sair?</p>
                <button onclick="confirmExit()" style="margin: 5px; padding: 5px 10px; background: #1a4f72; color: white; border: none; border-radius: 3px;">Sim</button>
                <button onclick="closeExitModal()" style="margin: 5px; padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 3px;">Não</button>
            </div>
        </div>

        <div id="alertModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; justify-content: center; align-items: center;">
            <div style="background: white; padding: 20px; border-radius: 5px; text-align: center;">
                <h3>Alerta</h3>
                <p id="alertMessage"></p>
                <button onclick="closeAlert()" style="margin-top: 10px; padding: 5px 10px;">Fechar</button>
            </div>
        </div>
    </div>
</body>
</html>
